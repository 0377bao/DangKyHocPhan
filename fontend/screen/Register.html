<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>
    <link rel="stylesheet" type="text/css" href="../css/Register.css">
    <script src="../js/Home.js"></script>
    <script src="../js/Register.js"></script>
</head>
<body>
    <div class="container">
        <!-- header -->
        <div class="logo-banner">
            <img src="../img/banner.png" alt="banner">
        </div>

        <!-- menu -->
        <div class="menu">
            <!-- Thông tin cá nhân -->
            <div class="menu-personal">
                <p>Xin chào!</p>
                <p><h2>Lê Hữu Bằng</h2></p>
                <p>Giới tính: </p>
                <p>MSSV:</p>
                <p>Trạng thái:</p>

                <button type="submit" onclick="login()">Đăng xuất</button>
            </div>

            <div class="img-avatar">
                <img src="../img/user.png" alt="user">
            </div>

            <!-- Menu đăng ký học phần -->
            <div class="menu-item">
                <a href="Home.html">THÔNG TIN SINH VIÊN</a> <br>
                <a href="Register.html">ĐĂNG KÝ HỌC PHẦN</a> <br>
                <a href="Curriculum.html">CHƯƠNG TRÌNH KHUNG</a>
            </div>
        </div>

        <!-- content -->
        <div class="content">
            <h2>ĐĂNG KÝ HỌC PHẦN</h2> <br>
            <div class="content-both">
                <!-- Đợt đăng ký -->
                <div class="content-register">
                    <b>Đợt đăng ký</b>

                    <!-- Chọn học kỳ: -->
                    <select id="semesterSelect" onchange="fetchCourseData(); fetchEnrollmentData();">
                        <option value="1">HK1 (2021- 2022)</option>
                        <option value="2">HK2 (2021- 2022)</option>
                        <option value="3">HK3 (2021- 2022)</option>
                    </select>

                    <!-- Radio -->
                    <input type="radio" id="hocMoi" name="gender" value="hocMoi" checked>
                    <label for="hocMoi">HỌC MỚI</label>
            
                    <input type="radio" id="hocLai" name="gender" value="hocLai">
                    <label for="hocLai">HỌC LẠI</label>
            
                    <input type="radio" id="hocCaiThien" name="gender" value="hocCaiThien">
                    <label for="hocCaiThien">HỌC CẢI THIỆN</label>
                </div>

                <!-- Môn học phần đang chờ đăng ký -->
                <div class="content-subject">
                    <h3>MÔN HỌC PHẦN ĐANG CHỜ ĐĂNG KÝ</h3>
                    <form action="" class="table-register">
                        <table>
                            <thead>
                                <tr>
                                    <th>ㅤㅤ</th>
                                    <th>STT</th>
                                    <th>Mã MH cũ</th>
                                    <th>Mã HP</th>
                                    <th>Tên môn học</th>
                                    <th>TC</th>
                                    <th>Bắt buộc</th>
                                    <th>Học phần: học trước (a), tiên <br> quyết (b), song hành (c)</th>
                                    <th>Học phần tương đương</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </form>
                </div>

                <div class="content-subject4" style="display: none;">
                    <h3>LỚP HỌC PHẦN CHỜ ĐĂNG KÝ</h3>
                    <form action="" class="table-register4">
                        <table>
                            <thead>
                                <tr>
                                    <th>ㅤㅤ</th>
                                    <th>STT</th>
                                    <th>Mã LHP</th>
                                    <th>Tên Lớp học phần</th>
                                    <th>Lớp dự kiến</th>
                                    <th>Sĩ số tối đa</th>
                                    <th>Đã đăng ký</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </form>
                </div>

                <div class="content-subject1" style="display: none;">
                    <h3>CHI TIẾT LỚP HỌC PHẦN</h3>
                    <div class="content-honestly">
                        <label>Nhóm thực hành</label>
                        <select id="practiceGroupSelect">
                            <option value="1">ㅤㅤ</option>
                            <option value="2">No results found</option>
                        </select>
                    </div>
                    <form action="" class="table-register1">
                        <table id="courseDetailTable">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Lịch học</th>
                                    <th>Loại lịch</th>
                                    <th>Phòng</th>
                                    <th>Tiết học</th>
                                    <th>Cơ sở</th>
                                    <th>Giảng viên</th>
                                    <th>ㅤㅤ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </form>
                
                    <button type="button" class="register-subject" onclick="registerCourse()">Đăng ký môn học</button>
                </div>

                <div id="enrollment-container">
                    <div class="content-subject2">
                        <h3>LỚP HỌC PHẦN ĐÃ ĐĂNG KÝ TRONG KÌ HỌC NÀY (ĐÃ KHÓA LỚP)</h3>
                        <form action="" class="table-register2">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Thao tác</th>
                                        <th>STT</th>
                                        <th>Mã LHP</th>
                                        <th>Tên môn học</th>
                                        <th>Lớp học dự kiến</th>
                                        <th>Số TC</th>
                                        <th>Nhóm TH</th>
                                        <th>Học Phí</th>
                                        <th>Hạn nộp</th>
                                        <th>Thu</th>
                                        <th>Trạng thái ĐK</th>
                                        <th>Ngày Đk</th>
                                        <th>Trạng Thái LHP</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </form>
                    </div>
                    <div class="content-subject2">
                        <h3>LỚP HỌC PHẦN ĐÃ ĐĂNG KÝ TRONG KÌ HỌC NÀY (CHỜ SINH VIÊN ĐĂNG KÝ)</h3>
                        <form action="" class="table-register3">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Thao tác</th>
                                        <th>STT</th>
                                        <th>Mã LHP</th>
                                        <th>Tên môn học</th>
                                        <th>Lớp học dự kiến</th>
                                        <th>Số TC</th>
                                        <th>Nhóm TH</th>
                                        <th>Học Phí</th>
                                        <th>Hạn nộp</th>
                                        <th>Thu</th>
                                        <th>Trạng thái ĐK</th>
                                        <th>Ngày Đk</th>
                                        <th>Trạng Thái LHP</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </form>
                    </div>
                </div>                
            </div> 
        </div>

         <!-- footer -->
         <div class="footer">
            <div class="left-footer">
                <b>TRƯỜNG ĐẠI HỌC CÔNG NGHIỆP THÀNH PHỐ HỒ CHÍ MINH</b> <br>
                <p>Địa chỉ: 12 Nguyễn Văn Bảo, phường 4, quận Gò Vấp, TP.Hồ Chí Minh </p> 
                <p>Điện thoại: 0283 8940 390 </p>
                <p>Fax: 0283 9940 954 </p> 
                <p>Email: dhcn@iuh.edu.vn</p> 
            </div>
    
            <div class="right-footer">
                <p>Thống kê truy cập</p> 
                <p>Lượt truy cập: 2038569</p> 
                <p>Đang online: 345</p>
            </div>
        </div>

        <div class="footer-butoom">
            <p>Bảng quyền 2018 - Trường Đại học Công nghiệp TP. Hồ Chí Minh</p>
        </div>

    </div>

    <script>
        let selectedClassId = null;

        function login() {
            // Chuyển hướng sang trang Home.html
            window.location.href = "LoginRegister.html";
        }

        document.addEventListener("DOMContentLoaded", function() {
            // Initial fetch when the page loads
            fetchCourseData();
            fetchEnrollmentData();
        });
        
        function fetchCourseData() {
            const semesterId = document.getElementById('semesterSelect').value;
            fetch(`http://localhost:8080/api/dkhp/CourseOpening/${semesterId}`)
                .then(response => response.json())
                .then(data => {
                    updateCoursesTable(data.data.dsKhoaHoc);
                })
                .catch(error => console.error('Error fetching course data:', error));
        }
        
        function updateCoursesTable(courses) {
            const tbody = document.querySelector('.table-register tbody');
            tbody.innerHTML = ''; // Clear existing rows
            courses.forEach((course, index) => {
                const monTienQuyetTest = course.monTienQuyet?.map((item) => item.tenMonHoc).join(', ') || '';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="radio" name="courseSelection" onclick="fetchClassDetails(${course.id})"></td>
                    <td>${index + 1}</td>
                    <td>${course.id}</td>
                    <td>${course.id}</td>
                    <td>${course.tenMonHoc}</td>
                    <td>${course.soTinChi}</td>
                    <td><img src="../img/check.png" alt=""></td> <!-- Placeholder for Bắt buộc -->
                    <td>${monTienQuyetTest}</td> <!-- Process prerequisites -->
                    <td></td> <!-- Placeholder for Học phần tương đương -->
                `;
                tbody.appendChild(row);
            });
        }

        function fetchClassDetails(courseId) {
            fetch(`http://localhost:8080/api/admin/clazz/clazzPlan?courseId=${courseId}&status=Chờ sinh viên đăng ký`)
                .then(response => response.json())
                .then(data => {
                    updateClassTable(data.data);
                    document.querySelector('.content-subject4').style.display = 'block';
                })
                .catch(error => console.error('Error fetching class details:', error));
        }

        function updateClassTable(classes) {
            const tbody = document.querySelector('.table-register4 tbody');
            tbody.innerHTML = ''; // Clear previous entries
            classes.forEach((clazz, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="radio" name="classSelection" onclick="fetchCourseDetails(${clazz.maLop}); selectedClassId = ${clazz.maLop};"></td>
                    <td>${index + 1}</td>
                    <td>${clazz.maLop}</td>
                    <td>${clazz.tenMonHoc}</td>
                    <td>${clazz.tenLop}</td>
                    <td>${clazz.siSoToiDa}</td>
                    <td>${clazz.siSoHienTai}</td>
                    <td>${clazz.trangThai}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function fetchCourseDetails(classId) {
            fetch(`http://localhost:8080/api/dkhp/Enrollment/detail/${classId}`)
                .then(response => response.json())
                .then(data => {
                    updateCourseDetailsTable(data.data);
                    document.querySelector('.content-subject1').style.display = 'block';
                })
                .catch(error => console.error('Error fetching course details:', error));
        }

        function updateCourseDetailsTable(details) {
            const tbody = document.querySelector('#courseDetailTable tbody');
            tbody.innerHTML = ''; // Clear previous entries
            details.forEach((detail, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${detail.thu}</td>
                    <td>${detail.loaiLich}</td>
                    <td>${detail.phongHoc}</td>
                    <td>${detail.tietHoc}</td>
                    <td>Cơ sở 1</td>
                    <td>${detail.tenGiangVien}</td>
                    <td><button type="button" style="background-color: #0069d9; color: #fff; border-width: 0; height: 25px; width: 45%;">Xem</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        function registerCourse() {
            const semesterId = document.getElementById('semesterSelect').value;
            const semesterText = document.getElementById('semesterSelect').options[document.getElementById('semesterSelect').selectedIndex].text;
            const requestBody = {
                "student_id": 1,
                "class_id": selectedClassId,
                "ngayBatDau": "2021-08-18",
                "ngayKetThuc": "2021-12-10",
                "hocKi": semesterText
            };

            fetch('http://localhost:8080/api/dkhp/Enrollment/createEnrollment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Registration successful:', data);
                alert('Đăng ký thành công!');
                addEnrollmentToTable(data.data); // Add new enrollment to the table
            })
            .catch(error => console.error('Error registering course:', error));
        }

        function addEnrollmentToTable(enrollment) {
            const semesterId = document.getElementById('semesterSelect').value;
            const tbody = document.querySelector('.table-register3 tbody');
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="../img/option.png" alt="" onclick="showCancelOption(this, ${enrollment.classId})"></td>
                <td>${tbody.children.length + 1}</td>
                <td>${enrollment.classId}</td>
                <td>${enrollment.tenMonHoc}</td>
                <td>${enrollment.tenLopHocPhan}</td>
                <td>${enrollment.soTinChi}</td>
                <td>-</td> <!-- Placeholder for Nhóm TH -->
                <td>${enrollment.hocPhi}</td>
                <td>${enrollment.ngayKetThuc}</td> <!-- Assuming this is the payment deadline -->
                <td><img src="../img/check.png" alt=""></td> <!-- Placeholder for Thu -->
                <td>Đăng ký mới</td>
                <td>${enrollment.ngayBatDau}</td>
                <td>${enrollment.trangThaiLop}</td>
            `;
            tbody.appendChild(row);
        }

        function showCancelOption(icon, classId) {
            const cancelButton = document.createElement('button');
            cancelButton.innerText = 'Hủy';
            cancelButton.style.backgroundColor = '#d9534f';
            cancelButton.style.color = '#fff';
            cancelButton.style.borderWidth = '0';
            cancelButton.style.marginLeft = '10px';
            cancelButton.onclick = function() {
                cancelEnrollment(classId);
            };
            icon.parentNode.appendChild(cancelButton);
            icon.style.display = 'none'; // Hide the option icon
        }

        function cancelEnrollment(classId) {
            const studentId = 1; // Assuming the student ID is 1, update as necessary
            fetch(`http://localhost:8080/api/dkhp/Enrollment/delete?studentId=${studentId}&classId=${classId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                alert('Hủy đăng ký thành công!');
                fetchEnrollmentData(); // Refresh the enrollment table
            })
            .catch(error => console.error('Error cancelling enrollment:', error));
        }

        function fetchEnrollmentData() {
            const semesterId = document.getElementById('semesterSelect').value;
            fetch(`http://localhost:8080/api/dkhp/Enrollment/${semesterId}`)
                .then(response => response.json())
                .then(data => {
                    updateEnrollmentTables(data.data);
                })
                .catch(error => console.error('Error fetching enrollment data:', error));
        }

        function updateEnrollmentTables(enrollments) {
            const tbodyHK1 = document.querySelector('.table-register2 tbody');
            const tbodyHK2 = document.querySelector('.table-register3 tbody');
            tbodyHK1.innerHTML = ''; // Clear existing rows
            tbodyHK2.innerHTML = ''; // Clear existing rows
            
            enrollments.forEach((enrollment, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="../img/option.png" alt="" onclick="showCancelOption(this, ${enrollment.classId})"></td>
                    <td>${index + 1}</td>
                    <td>${enrollment.classId}</td>
                    <td>${enrollment.tenMonHoc}</td>
                    <td>${enrollment.tenLopHocPhan}</td>
                    <td>${enrollment.soTinChi}</td>
                    <td>-</td> <!-- Placeholder for Nhóm TH -->
                    <td>${enrollment.hocPhi}</td>
                    <td>${enrollment.ngayKetThuc}</td> <!-- Assuming this is the payment deadline -->
                    <td><img src="../img/check.png" alt=""></td> <!-- Placeholder for Thu -->
                    <td>${enrollment.trangThaiLop}</td>
                    <td>${enrollment.ngayBatDau}</td>
                    <td>${enrollment.trangThaiLop}</td>
                `;

                if (enrollment.trangThaiLop === "Đã khóa lớp") {
                    tbodyHK1.appendChild(row);
                } else if (enrollment.trangThaiLop === "Chờ sinh viên đăng ký") {
                    tbodyHK2.appendChild(row);
                }
            });
        }
    </script>
</body>
</html>
